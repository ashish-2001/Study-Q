// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}
model Course {
    id               Int              @id @default(autoincrement())
    appxCourseId     String
    title            String
    imageUrl         String
    description      String
    openToEveryOne   Boolean          @default(false)
    slug             String
    content          CourseContent[]  
    purchasedBy      UserPurchases[]
}

model UserPurchases {
    user         User      @relation(fields: [userId], references: [id])
    userId       String
    course       Course    @relation(fields: [courseId], references: [id])
    courseId     Int
    assignedAt   DateTime  @default(now())

    @@id([userId, courseId])
}

model Content {
    id              Int                @id @default(autoincrement())     
    type            String             @default("folder")
    title           String        
    hidden          Boolean            @default(false)
    description     String?
    thumbnail       String?
    parentId        Int?
    parent          Content            @relation("ContentToContent", fields: [parentId], references: [id])
    videoProgress   VideoProgress[]
    children        Content[]          @relation("ContentTOContent")
    courses         CourseContent      
    createdAt       DateTime           @default(now())
    VideoMetaData   VideoMetaData?
    NotionMetaData  NotionMetaData?    
    notionMetaData  Int?
    comments        Comment[]
    commentsCount   Int                 @default(0)
    bookmark        Bookmark[]
}

model CourseContent {
    course      Course   @relation(fields: [courseId], references: [id])
    courseId    Int
    content     Content  @relation(fields: [contentId], references: [id])
    contentId   Int

    @@id([courseId, contentId])
}

model NotionMetaData {
    id           Int       @id @default(autoincrement())
    contentId    Int
    content      Content   @relation(fields: [contentId], references: [id])
    notionId     String

    @@unique([contentId])
}

model VideoMetaData {
    id                          Int              @id @default(autoincrement())
    contentId                   Int
    appxVideoId                 String?
    appxVideoJson               Json?
    video_1080_mp4_1            String?
    video_1080_mp4_2            String?
    video_1080_mp4_3            String?
    video_1080_mp4_4            String?
    video_1080p_1               String?
    video_1080p_2               String?
    video_1080p_3               String?
    video_1080p_4               String?
    video_720p_mp4_1            String?
    video_720p_mp4_2            String?
    video_720p_mp4_3            String?
    video_720p_mp4_4            String?
    video_720p_1                String?
    video_720p_2                String?
    video_720p_3                String?
    video_720p_4                String?
    video_360p_mp4_1            String?
    video_360p_mp4_2            String?
    video_360p_mp4_3            String?
    video_360p_mp4_4            String?
    video_360p_1                String?
    video_360p_2                String?
    video_360p_3                String?
    video_360p_4                String?
    subtitles                   String?
    subtitle_tried              Int                 @default(0)
    segments                    Json?
    content                     Content             @relation(fields: [contentId],  references: [id])
    slides                      String?
    thumbnail_mosiac_url        String?
    duration                    Int?
    migration_status            MigrationStatus      @default(NOT_MIGRATED)
    migration_pickup_time       DateTime?           
    migrated_video_1080p_mp4_1  String?
    migrated_video_360p_mp4_1   String?
    migrated_video_720p_mp4_1   String?
    original_mp4_url            String?
    transcoded                  Boolean       @default(false)

    @@unique([contentId])
}

model Session {
    id               String     @id @default(cuid())
    sessionToken     String     @unique
    userId           String
    expires          DateTime
    user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id                    String           @id  @default(cuid())
    name                  String?
    email                 String            @unique
    token                 String?
    sessions              Session[]
    purchases             UserPurchases[]
    videoProgress         VideoProgress[]
    comments              Comment[]
    votes                 Vote[]
    disableDrm            Boolean            @default(false)
    bunnyProxyEnabled     Boolean            @default(false)
    bookmarks             Bookmark[]
    password              String?
    appxUserId            String?
    appxUsername          String?
    appxAuthToken         String?
    questions             Question[]
    answers               Answer[]
    upiIds                UpiId[]             @relation("UserUpiIds")
    githubUser            GitHubLink?         @relation("UserGithub")
}

model GitHubLink {
    id              String       @id  @default(cuid())
    userId          String       @unique
    user            User         @relation("UserGithub", fields: [userId], references: [id], onDelete: Cascade)
    githubId        String
    username        String
    avatarUrl       String?
    access_token    String?
    profileUrl      String?
    createdAt       DateTime     @default(now())
    updatedAt       DateTime     @updatedAt
}

model UpiId {
    id        Int     @id  @default(autoincrement())
    value     String  @db.VarChar(256)
    userId    String
    user      User    @relation("UserUpiIds", fields: [userId], references: [id])

    @@unique([userId, value])
}

model VideoProgress {
    id                  Int       @id @default(autoincrement())
    userId              String
    contentId           Int
    currentTimestamp    Int
    user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    content             Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
    markAsCompleted     Boolean   @default(false)
    updatedAt           DateTime  @default(now()) @updatedAt

    @@unique([contentId, userId])
}

model Bookmark {
    id           Int       @id @default(autoincrement())
    userId       String
    contentId    Int
    user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    content      Content   @relation(fields: [contentId], references: [id])
    createdAt    DateTime  @default(now())
}

model Comment {
    id           Int           @id @default(autoincrement())
    content      String   
    commentType  CommentType   @default(DEFAULT)
    approved     Boolean       @default(false)
    contentId    Int
    commentedOn  Content       @relation(fields: [contentId], references: [id])
    parentId     Int?
    parent       Comment?      @relation("ParentComment", fields: [parentId], references: [id])
    children     Comment[]     @relation("ParentComment")
    userId       String
    user         User          @relation(fields: [userId], references: [id])
    upvotes      Int           @default(0)
    downvotes    Int           @default(0)
    repliesCount Int           @default(0)
    createdAt    DateTime      @default(now())
    updatedAt    DateTime      @updatedAt
    votes        Vote[]
    isPinned     Boolean       @default(false)
}

model Question {
    id           Int           @id @default(autoincrement())
    title        String
    content      String
    slug         String        @unique
    createdAt    DateTime      @default(now())
    author       User          @relation(fields: [authorId], references: [id])
    authorId     String
    upvotes      Int           @default(0)
    downvotes    Int           @default(0)
    totalanswers Int           @default(0)
    answers      Answer[]      
    votes        Vote[]
    tags         String[]
    updatedAt    DateTime      @updatedAt

    @@index([authorId])
}


model Answer {
    id           Int           @id @default(autoincrement())
    content      String
    createdAt    DateTime      @default(now())
    question     Question      @relation(fields: [questionId], references: [id])
    questionId   Int
    author       User          @relation(fields: [authorId], references: [id])
    authorId     String
    votes        Vote[]
    upvotes      Int           @default(0)
    downvotes    Int           @default(0)
    totalanswers Int           @default(0)
    parentId     Int?
    responses    Answer        @relation("AnswerToAnswer")
    parent       Answer?       @relation("AnswerToAnswer", fields: [parentId], references: [id])
    updatedAt    DateTime      @updatedAt

    @@index([questionId])
    @@index([authorId])
    @@index([parentId])
}

model Vote {
    id           Int            @id @default(autoincrement())
    questionId   Int?
    question     Question?      @relation(fields: [questionId], references: [id])
    answerId     Int? 
    answer       Answer?        @relation(fields: [answerId], references: [id])
    commentId    Int?           
    comment      Comment?       @relation(fields: [commentId], references: [id])
    userId       String       
    user         User           @relation(fields: [userId], references: [id])
    createdAt    DateTime       @default(now())

    @@unique([questionId, userId])
    @@unique([answerId, userId])
    @@unique([commentId, userId])
}

model Event {
    id            Int           @id @default(autoincrement())
    title         String  
    start         DateTime
    end           DateTime
    videoLink     String?
    notes         String?
    createdAt     DateTime      @default(now())
    updatedAt     DateTime      @updatedAt 
}

enum PostType {
    QUESTION
    ANSWER
}

enum CommentType {
    INTRO
    DEFAULT
}

enum MigrationStatus {
    NOT_MIGRATED
    MIGRATED
    MIGRATION_ERROR
}


